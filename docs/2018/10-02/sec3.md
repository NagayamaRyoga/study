# III. Embedding preformance

埋め込みパフォーマンスについて言及するとき、プロジェクトに埋め込むことの出来るbit数が重要になる。
埋め込み手法から、パフォーマンスは各関数でいくつの変数が宣言され、どれだけ多くの独立した文のグループが見つかるかという2つの要素によって決まる。

ただし、実際的な制限によりパフォーマンスが低下する。その中でもっとの顕著なものは以下のとおりである。

1. ブロックの先頭に宣言された変数のみを置換する。
    しかしC++の場合、通常変数は使用される場所で宣言される。
    コンパイラレベルでこれらの変数のメモリ割り当てを変更することは可能だが、スコープと可視性に違反し、エラーに繋がる可能性があるため、ソースコード内の位置を変更することは出来ない。

    > inplace new と 明示的デストラクタ呼び出しで出来るのでは？

2. 一見独立した文に関数呼び出しが含まれている場合、それらを並び替えることは出来ない。
    これは関数に副作用がないことを確認できないためである。
    関数に副作用が存在する場合、文の位置を変更するとエラーが発生しうる。

    > constexpr指定されたフリー関数またはmutableメンバ変数を持たないクラスのconstexpr指定されたconstメンバ関数呼び出しは副作用を持たない。
    > (それも実用的な制限ではない。)

3. 一見独立した文に間接参照が含まれている場合、それらを並び替えることは出来ない。
    文の独立性を保証するために、ポインタと参照の内容をトレースするのは難しいからである。

後述の実験結果が示すようにこれらの制限が埋め込みパフォーマンスを大幅に低下させる。

実際のファイルへの埋め込みについて実用的な性能をテストするために、利用可能なソースコードを含むおよそ30のC/C++ Symbianプロジェクトをインターネット上でピックアップした。
いくつかのプロジェクトへの埋め込みパフォーマンス結果を表1に示す。

| Project Name                | The Number of C++ Files | The Size of C++ Files | The Length of Watermark |
|:----------------------------|:-----------------------:|:---------------------:|:-----------------------:|
| HView_v1_13beta_source      | 10                      | 58KB                  | 27 bit                  |
| SymTorrent_1.30_source_2007 | 104                     | 680KB                 | 40 bit                  |
| DosBox                      | 107                     | 2066KB                | 123 bit                 |
| putty_src_1.5.1             | 227                     | 3650KB                | 1018 bit                |
| vim                         | 395                     | 3980KB                | 207 bit                 |
| OpenVideoHub                | 405                     | 6853KB                | 2205 bit                |

残りのプロジェクトは、提案された透かしの埋め込み手法には完全に不適切で、0~10bitのみしか埋め込むことが出来なかった。

埋め込みパフォーマンスが低かったのは、上の制限に加え、オブジェクト指向技術の広範な使用がデータ埋め込み手法に対して相性が良くないことを示している。

ほとんどすべての操作はクラスのメンバ関数を伴い、メンバ変数への副作用が存在するかどうかを判断することは困難である。

オブジェクト指向プログラムへの適用にはさらなるアイデアが必要になる。
